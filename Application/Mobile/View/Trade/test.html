<!doctype html>
<html class="has-topbar has-bottombar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover" />
    <title>交易</title>
    <include file="Public:head" />
</head>
<body>
<header class="mui-bar mui-bar-bg mui-bar-nav">
    <!-- <h1 class="mui-title color_white">{$coin_name}/{$coin_type}<i class="icons iconfont icon-ai-arrow-down"></i></h1> -->
    <select name="mark" id="mark">

        <foreach name="list" item="vo">
            <if condition="$vo.title_ns eq $mark">
                <option selected='selected' id="selected" data="{$key}" value="{$vo.title_ns}">{$vo.title_ns}</option>
                <else/>
                <option data="{$key}" value="{$vo.title_ns}">{$vo.title_ns}</option>
            </if>
        </foreach>
    </select>
    <i class="icons iconfont icon-ai-arrow-down index_i"></i>
    <a class="mui-icon mui-pull-right iconfont icon-tongji" href="#"></a>
</header>
<script type="text/javascript">
    $('#mark').change(function(){
        var val = $(this).val();
        var data = val.toLowerCase();
        var info = data.replace('/','_');
        window.location.href="/Trade/test/market/"+info;
        //window.location.href = "{:U('trade/index')}"+'?market='+info;
    });
</script>
<div class="mui-content cur-padding-bottom">
    <div class="cur-box">
        <div class="marketinfo">
            <div class="fl price-show">
                <h3 id="market_new_price">--</h3>
                <p id="cny_prices">≈ {$rmbprice} CNY</p>
               <!-- <span>≈ {$rmbprice} {$market_coin}</span>-->
            </div>
            <div class="fr float buy" id="market_change">--</div>
        </div>

        <div class="table-entrust">
            <ul class="table-head">
                <li class="tl">{:L("买一价")}({$coin_type})</li>
                <li class="tc">{:L("数量")}({$coin_name})</li>
                <li class="tr">{:L("卖一价")}({$coin_type})</li>
            </ul>
            <div class="table-list">
                <dl class="fl coinlist-left" id="buylist"></dl>
                <dl class="fr coinlist-right" id="selllist"></dl>
            </div>
        </div>

        <div class="form-box">
            <div id="slider" class="form-info">
                <div id="sliderSegmentedControl" class="mui-slider-indicator mui-segmented-control mui-segmented-control-inverted form-tab">
                    <a class="mui-control-item mui-active" href="#item1">买入</a>
                    <a class="mui-control-item" href="#item2">卖出</a>
                </div>
            </div>

            <div class="form-trade">
                <div id="item1" class="mui-control-content mui-active">
                    <p class="info"><span class="fl">{:L("可用")} {$coin_type}</span><span class="fr red" id="buy_usable">--</span></p>
                    <div class="mui-numbox">
                        <span class="num-left">{:L("价格")}</span>
                        <span class="unit-right">{$coin_type}</span>
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number" name="price" id="buy_price" data-numbox-max="100000000" autocomplete="off"  />
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                    <div class="cny" id="buy_cny"><span class="fl hidden" ></span><span class="fl cont" id="buy_cont">≈0 CNY</span><span class="fr hidden right" ></span></div>
                    <div class="mui-numbox">
                        <span class="num-left">{:L("数量")}</span>
                        <span class="unit-right">{$coin_name}</span>
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input class="mui-numbox-input" type="number" name="num" id="buy_num" data-numbox-max="100000000" autocomplete="off" />
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                    <div class="mui-input-row mui-input-row-g">
                        <label>{:L("交易密码")}</label>
                        <input type="password" name="pwtrade" id="buy_paypassword" class="mui-input-clear" placeholder="请输入交易密码">
                    </div>
                    <p class="info"><span class="fl">{:L("交易额")} {$coin_type}</span><span class="fl red" id="buy_mum" style="padding-left: 10px">0.00</span><span class="fr">手续费:0.2%</span></p>

                    <if condition="$Think.session.userId eq '0'">
                        <button type="button" class="mui-btn mui-btn-red" onclick="tologin();">{:L("请先登录")}</button>
                        <else/>
                        <button type="button" class="mui-btn mui-btn-red" id="buybutton" onclick="ajaxDeal('buybutton');">{:L("买入")} {$coin_name}</button>
                    </if>
                </div>

                <div id="item2" class="mui-control-content">
                    <p class="info"><span class="fl">{:L("可用")} {$coin_name}</span><span class="fr green" id="sell_usable">--</span></p>
                    <div class="mui-numbox">
                        <span class="num-left">{:L("价格")}</span>
                        <span class="unit-right">{$coin_type}</span>
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input type="number" name="price" id="sell_price" class="mui-numbox-input" data-numbox-max="100000000" autocomplete="off" />
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                    <div class="cny" id="sell_cny"><span class="fl hidden" ></span><span class="fl cont" id="sell_cont">≈0 CNY</span><span class="fr hidden right" ></span></div>
                    <div class="mui-numbox">
                        <span class="num-left">{:L("数量")}</span>
                        <span class="unit-right">{$coin_name}</span>
                        <button class="mui-btn mui-numbox-btn-minus" type="button">-</button>
                        <input type="number" name="num" id="sell_num" class="mui-numbox-input" data-numbox-max="100000000" autocomplete="off" />
                        <button class="mui-btn mui-numbox-btn-plus" type="button">+</button>
                    </div>
                    <input type="hidden" name="TOKEN" value="{:session('__token__')}">
                    <div class="mui-input-row mui-input-row-g">
                        <label>{:L("交易密码")}</label>
                        <input type="password" name="pwtrade" id="sell_paypassword" class="mui-input-clear" placeholder="请输入交易密码">
                    </div>
                    <p class="info"><span class="fl">{:L("交易额")} {$coin_type}</span><span class="fl green" id="sell_mum" style="padding-left: 10px">0.00</span>
                    <span class="fr">手续费:0.2%</span></p>

                    <if condition="$Think.session.userId eq '0'">
                        <button type="button" class="mui-btn mui-btn-green" onclick="tologin();">{:L("请先登录")}</button>
                        <else/>
                        <button type="button" class="mui-btn mui-btn-green" id="sellerbutton" onclick="ajaxDeal('sellerbutton')">{:L("卖出")} {$coin_name}</button>
                    </if>
                </div>
            </div>
        </div>
    </div>

    <div class="cur-box trade_entrust">当前委托<a href="/Finance/mywt/type/undefined/market/{$market}" class="fr">历史委托</a></div>
    <div class="cur-box" style="">
        <dl class="trade_entrust_list">
            <dt class="title">
                <span style="width: 12%">类型</span>
                <span style="width: 25%">价格</span>
                <span style="width: 28%">待成交量</span>
                <span style="width: 17%">时间</span>
                <span style="width: 13%" class="tr">操作</span>
            </dt>
            <div class="trade_entrust_" id="entrustlist"></div>
        </dl>
    </div>
</div>
<script>
    $(function () {
        // 买
        $("#buy_price").bind("focus change",function () {
            $("#buy_cny").show();
            var price = $('#buy_price').val();
            var money =  "{$config['usdt']}";
            var sum = (price * money)*1;
            $("#buy_cont").html('≈' + sum + "CNY");
            if(price<=0) {
                $('#buy_price').val("0") 
                $("#buy_cny").hide()
            }


        })
        $(".mui-numbox button").click(function(){
            $("#buy_cny").show()
            var price = $('#buy_price').val();
            var money =  "{$config['usdt']}";
            var sum = (price * money)*1;
            $("#buy_cont").html('≈' + sum + "CNY");
            if(price<=0) {
                $('#buy_price').val("0") 
                $("#buy_cny").hide()
            }

        })
        $("#buy_price").bind("blur",function () {
            $("#sell_cny").hide()
        })
    

        //  卖
        $("#sell_price").bind("focus change",function () {
            $("#sell_cny").show();
            var price = $('#sell_price').val();
            var money =  "{$config['usdt']}";
            var sum = (price * money)*1;
            $("#sell_cont").html('≈' + sum + "CNY");
            if(price<=0) {
                $("#sell_cny").hide()
                $('#sell_price').val("0") 
            }
        })
        $(".mui-numbox button").click(function(){
            $("#sell_cny").show()
            var price = $('#sell_price').val();
            var money =  "{$config['usdt']}";
            var sum = (price * money)*1;
            $("#sell_cont").html('≈' + sum + "CNY");
            if(price<=0) {
                $("#sell_cny").hide()
                $('#sell_price').val("0") 
            }
        })
        $("#sell_price").bind("blur",function () {
            $("#sell_cny").hide()
        })

    })
</script>
<script>
    $(document).ready(function(){
        $('#menu_3').addClass('mui-active');
    });
    //过滤HTML标签
    function removeHTMLTag(str) {
        str = str.replace(/<\/?[^>]*>/g, ''); //去除HTML tag
        str = str.replace(/[ | ]*\n/g, '\n'); //去除行尾空白
        //str = str.replace(/\n[\s| | ]*\r/g,'\n'); //去除多余空行
        str = str.replace(/ /ig, ''); //去掉
        return str;
    }
</script>


<include file="Public:footer" />
<script>
    mui.init({
        swipeBack: false
    });
    (function($) {
        $('.mui-scroll-wrapper').scroll({
            indicators: true //是否显示滚动条
        });
        var html2 = '';
        var html3 = '';
        var item2 = document.getElementById('item2');
        var item3 = document.getElementById('item3');
        document.getElementById('slider').addEventListener('slide', function(e) {
            if (e.detail.slideNumber === 1) {
                if (item2.querySelector('.mui-loading')) {
                    /*setTimeout(function() {
                        item2.querySelector('.mui-scroll').innerHTML = html2;
                    }, 500);*/
                }
            } else if (e.detail.slideNumber === 2) {
                if (item3.querySelector('.mui-loading')) {
                    /*	setTimeout(function() {
                            item3.querySelector('.mui-scroll').innerHTML = html3;
                        }, 500);*/
                }
            }
        });
        var sliderSegmentedControl = document.getElementById('sliderSegmentedControl');
        $('.mui-input-group').on('change', 'input', function() {
            if (this.checked) {
                sliderSegmentedControl.className = 'mui-slider-indicator mui-segmented-control mui-segmented-control-inverted mui-segmented-control-' + this.value;
                //force repaint
                sliderProgressBar.setAttribute('style', sliderProgressBar.getAttribute('style'));
            }
        });
    })(mui);


    /**
     * 数字输入框
     * varstion 1.0.1
     * by Houfeng
     * Houfeng@DCloud.io
     */

    (function($) {

        var touchSupport = ('ontouchstart' in document);
        var tapEventName = touchSupport ? 'tap' : 'click';
        var changeEventName = 'change';
        var holderClassName = 'mui-numbox';
        var plusClassName = 'mui-numbox-btn-plus';
        var minusClassName = 'mui-numbox-btn-minus';
        var inputClassName = 'mui-numbox-input';

        var Numbox = $.Numbox = $.Class.extend({
            /**
             * 构造函数
             **/
            init: function(holder, options) {
                var self = this;
                if (!holder) {
                    throw "构造 numbox 时缺少容器元素";
                }
                self.holder = holder;
                options = options || {};
                options.step = parseFloat(options.step || 1);
                self.options = options;
                self.input = $.qsa('.' + inputClassName, self.holder)[0];
                self.plus = $.qsa('.' + plusClassName, self.holder)[0];
                self.minus = $.qsa('.' + minusClassName, self.holder)[0];
                self.checkValue();
                self.initEvent();
            },
            /**
             * 初始化事件绑定
             **/
            initEvent: function() {
                var self = this;
                self.plus.addEventListener(tapEventName, function(event) {
                    var val = parseFloat(self.input.value) + self.options.step;
                    self.input.value = val.toString();
                    $.trigger(self.input, changeEventName, null);
                });
                self.minus.addEventListener(tapEventName, function(event) {
                    var val = parseFloat(self.input.value) - self.options.step;
                    self.input.value = val.toString();
                    $.trigger(self.input, changeEventName, null);
                });
                self.input.addEventListener(changeEventName, function(event) {
                    self.checkValue();
                    var val = parseFloat(self.input.value);
                    //触发顶层容器
                    $.trigger(self.holder, changeEventName, {
                        value: val
                    });
                });
            },
            /**
             * 获取当前值
             **/
            getValue: function() {
                var self = this;
                return parseFloat(self.input.value);
            },
            /**
             * 验证当前值是法合法
             **/
            checkValue: function() {
                var self = this;
                var val = self.input.value;
                if (val == null || val == '' || isNaN(val)) {
                    self.input.value = self.options.min || 0;
                    self.minus.disabled = self.options.min != null;
                } else {
                    var val = parseFloat(val);
                    if (self.options.max != null && !isNaN(self.options.max) && val >= parseFloat(self.options.max)) {
                        val = self.options.max;
                        self.plus.disabled = true;
                    } else {
                        self.plus.disabled = false;
                    }
                    if (self.options.min != null && !isNaN(self.options.min) && val <= parseFloat(self.options.min)) {
                        val = self.options.min;
                        self.minus.disabled = true;
                    } else {
                        self.minus.disabled = false;
                    }
                    self.input.value = val;
                }
            },

            /**
             * 更新选项
             **/
            setOption: function(name, value) {
                var self = this;
                self.options[name] = value;
            }
        });

        $.fn.numbox = function(options) {
            var instanceArray = [];
            //遍历选择的元素
            this.each(function(i, element) {
                if (element.numbox) return;
                if (options) {
                    element.numbox = new Numbox(element, options);
                } else {
                    var optionsText = element.getAttribute('data-numbox-options');
                    var options = optionsText ? JSON.parse(optionsText) : {};
                    options.step = element.getAttribute('data-numbox-step') || options.step;
                    options.min = element.getAttribute('data-numbox-min') || options.min;
                    options.max = element.getAttribute('data-numbox-max') || options.max;
                    element.numbox = new Numbox(element, options);
                }
            });
            return this[0] ? this[0].numbox : null;
        }

        //自动处理 class='mui-locker' 的 dom
        $.ready(function() {
            $('.' + holderClassName).numbox();
        });

    }(mui))
</script>
</body>
</html>
<script>
    var market = "{$market}";
    var market_round = "{$C['market'][$market]['round']}";
    var market_round_num = "{$C['market'][$market]['round']}";
    var trans_lock = 0;
    ws = new WebSocket("ws://"+document.domain+":8331");
    function show(){
        ws.send('heart beat\n');
        // var myDate = new Date();
        //console.log(123+":"+myDate);
    }

    function toNum(num,round){
        var mum=Math.round(num*Math.pow(10,round))/Math.pow(10,round);
        if(mum<0){var mum=0;}
        return mum;
    }
    // 买卖价格与数量 绑定键盘与选择事件
    $('#buy_price,#buy_num,#sell_price,#sell_num').css("ime-mode","disabled").bind('keyup change',function(){
        var buyprice=parseFloat($('#buy_price').val());
        var buynum=parseFloat($('#buy_num').val());
        var sellprice=parseFloat($('#sell_price').val());
        var sellnum=parseFloat($('#sell_num').val());
        var buymum=buyprice*buynum;
        var sellmum=sellprice*sellnum;
        var fee = "{:C('market')[$market]['fee_buy']}";
        var myrmb=$("#buy_usable").html();
        var myxnb=$("#sell_usable").html();
        var buykenum=0;
        var sellkenum=0;
        if(myrmb>0){
            buykenum=myrmb/buyprice;
        }
        if(myxnb>0){
            sellkenum=myxnb;
        }
        if(buyprice!=null&&buyprice.toString().split(".")!=null&&buyprice.toString().split(".")[1]!=null){
            if(buyprice.toString().split('.')[1].length>market_round){
                $('#buy_price').val(toNum(buyprice,market_round));
            }
        }
        if(buynum!=null&&buynum.toString().split(".")!=null&&buynum.toString().split(".")[1]!=null){
            if(buynum.toString().split('.')[1].length>market_round_num){
                $('#buy_num').val(toNum(buynum,market_round_num));
            }
        }
        if(sellprice!=null&&sellprice.toString().split(".")!=null&&sellprice.toString().split(".")[1]!=null){
            if(sellprice.toString().split('.')[1].length>market_round){
                $('#sell_price').val(toNum(sellprice,market_round));
            }
        }
        if(sellnum!=null&&sellnum.toString().split(".")!=null&&sellnum.toString().split(".")[1]!=null){
            if(sellnum.toString().split('.')[1].length>market_round_num){
                $('#sell_num').val(toNum(sellnum,market_round_num));
            }
        }
        if(buymum!=null&&buymum>0){
            $('#buy_mum').html(toNum(buymum,market_round_num)*1);
            var mum_fee = (toNum(buymum,market_round_num)*fee*1)/100;
            $('#buy_mumfee').html(mum_fee);

        }
        if(sellmum!=null&&sellmum>0){
            $('#sell_mum').html(toNum(sellmum,market_round_num)*1);
            var mum_fee = (toNum(sellmum,market_round_num)*fee*1)/100;
            $('#sell_mum_fee').html(mum_fee);
        }
        if(buykenum!=null&&buykenum>0&&buykenum!='Infinity'){
            $('#buy_max').html(toNum(buykenum,market_round_num));
            //$('#buy_max').html(toNum(buykenum,market_round_num));
        }
        if(sellkenum!=null&&sellkenum>0&&sellkenum!='Infinity'){
            $('#sell_max').html(toNum(sellkenum,market_round_num));
        }
    }).bind("paste",function(){
        return false;
    }).bind("blur",function(){
        if(this.value.slice(-1)=="."){
            this.value=this.value.slice(0,this.value.length-1);
        }
    }).bind("keypress",function(e){
        var code=(e.keyCode ? e.keyCode : e.which); //compatible:Firefox,IE
        if(this.value.indexOf(".")==-1){
            return (code>=48&&code<=57)||(code==46);
        }else{
            return code>=48&&code<=57
        }
    });
    ws.onopen = function(e){

        console.info(e);
        ws.send('test msg');//相当于发送一个初始化信息
        console.info("向服务端发送心跳包字符串");
        setInterval(show,5000);

    }
    var trade_qu_id = $("#selected").attr("data");
    var trade_moshi = 1;
    // 服务端主动推送消息时会触发这里的onmessage
    ws.onmessage = function(e){

        // json数据转换成js对象
        var data = JSON.parse(e.data);
        console.log(data);
        /*    if(i==1){
                setCookie('client_id',data.client_id);
            }*/
        var type = data.type || '';

        switch(type){
            // Events.php中返回的init类型的消息，将client_id发给后台进行uid绑定
            case 'init':
                // 利用jquery发起ajax请求，将client_id发给后端进行uid绑定
                /*    $.post(
                        "{:url('/Wokerman/getInfo')}",
                        {
                            'client_id': data.client_id,
                            'market':"{$market}",
                            'trade_moshi':trade_moshi,
                            'trade_qu_id':trade_qu_id,
                            'time':time,
                        },
                        function(data)
                        {
                          alert(1123);
                        },
                        'json');*/
                $.ajax({
                    url:"{:url('/Workerman/getInfo')}",
                    type:"post",

                    data:{
                        'client_id': data.client_id,
                        'market':"{$market}",
                        'trade_moshi':trade_moshi,
                        'trade_qu_id':trade_qu_id,

                    },
                    success:function (data) {

                    },
                    error:function (e) {
                        console.log(e)
                    }

                });
                break;
            case 'lineK':

                window[data.method](data.data)
                break
            case  'say':
                $("[name='TOKEN']").val(data.tokens);
                break;

            case 'getJsonTop':

                //头部涨跌幅信息
                getJsonTops(data.getJsonTop);
                // 我的财产 我的委托
                myGetzican(data.getEntrustAndUsercoin)
                //交易委托信息
                information(data.getDepth)
                //最新交易信息
                newestOrder(data.getTradelog)
                //币种行情
                currency(data.getJsonTop2);
                break
            case 'break':
                console.log(data.info);
                break
            // 当mvc框架调用GatewayClient发消息时直接alert出来
            default :
                console.log(data);
            //  alert(e.data);
        }
    };

</script>
<script>
    //撤销
    function cancelaa(id){
        layer.load(0, {shade: [0.5,'#8F8F8F']});
        $.post("{:U('Trade/chexiao')}",{
            'id' : id ,
            'trade_qu_id': $('.table-section-title .active').attr('data'),
            "market" : market,
        },function(data){
            //   setTimeout("closetanchu()",4000);
            if(data.status==1){
                layer.closeAll('loading');
                trans_lock = 0;
                // getEntrustAndUsercoin();
                layer.msg(data.info,{icon : 1 });
            }else{
                layer.closeAll('loading');
                trans_lock = 0;
                layer.msg(data.info,{icon : 2 });
            }
        });
    }
    //创建买卖单
    function ajaxDeal(type) {
        var tokens = $("[name='TOKEN']").val();

        if(type=='buybutton' ){
            var types=1;
            var num =$('#buy_num').val();
            var password =  $('#buy_paypassword').val();
            var price = $('#buy_price').val();
        }else if(type=='sellerbutton' ){
            var types=2;
            var num =$('#sell_num').val();
            var password =  $('#sell_paypassword').val();
            var price = $('#sell_price').val();
        }else{
            return
        }
        num = removeHTMLTag(num);
        password =removeHTMLTag(password);
        price = removeHTMLTag(price);

        if(trans_lock){
            layer.msg("{:L('不要重复提交')}",{icon : 2 }); return;
        }
        trans_lock = 1;
        layer.load(2);
        $.ajax({
            url: "{:U('Trade/upTrade')}",
            type: "POST",
            data: {
                'price': price,
                'num': num,
                'paypassword': password,
                'type': types,
                'market': market,
                'trade_qu_id': $('.table-section-title .active').attr('data'),
                'tokens':tokens,
            },
            success: function (e) {
                layer.closeAll('loading');
                trans_lock = 0;


                //    $("[name='TOKEN']").val("{:session('__token__')}");
                $('#buy_paypassword').val('');
                $('#sell_paypassword').val('');
                if (e instanceof Object) {
                    layer.msg(e.info, {icon: 2});
                    //setTimeout("window.location.reload()",1500);
                    return;
                }
                var reg = /<[^<>]+>/g;
                var mes = e.replace(reg, "");
                var arr = mes.replace(/float\(\d\)+/g, '');
                var data = JSON.parse(arr);
                if (data.status == 1) {
                    $("#buy_price").val('');
                    $("#buy_num").val('');
                    $('#buy_paypassword').val('');
                    $("#sell_price").val('');
                    $("#sell_num").val('');
                    $('#sell_paypassword').val('');
                    layer.msg(data.info, {icon: 1});
                    // window.location.reload();
                } else {
                    layer.msg(data.info, {icon: 2});
                    //   window.location.reload();
                }
            }
        })
    }
    function autotrust(_this, type, cq, nums) {
        $('#buy_price,#sell_price').val( parseFloat(removeHTMLTag($(_this).children().eq(cq).html())) );

        // if(nums > 0){
        // 	var bs_num = parseFloat(removeHTMLTag($(_this).children().eq(nums).html()));
        // }

        if(type == 'sell'){
            /*		if ($("#buy_usable").html() > 0 && nums > 0) {
                        //$('#buy_num').val(bs_num);
                        if (bs_num >= $("#buy_usable").html()) {
                            $("#buy_num").val(toNum(($("#buy_usable").html() / $('#buy_price').val()), market_round_num));
                        } else {
                            $('#buy_num').val(bs_num);
                        }
                    }*/
            // 点击相应的档位 数量累加到输入框
            var obj = $(_this).parents('#selllist').children();
            var this_id = $(_this).children(".num").data("id");

            var this_val= parseFloat($(_this).children(".num").data("val"));

            for(var j = this_id+1;j<obj.length;j++){
                this_val +=parseFloat($(obj[j]).children(".num").data("val"));
            }

            $('#sell_num').val(this_val)
            $('#buy_num').val(this_val)
            if ($('#buy_num').val()) {
                $('#buy_num').val();
                $("#buy_mum").html(($('#buy_num').val() * $('#buy_price').val()).toFixed(8) * 1);
            } else {
                $('#buy_num').val('');
                $('#buy_mum').html('0.00');
            }

            if ($('#sell_num').val()) {
                $('#sell_num').val()
                $("#sell_mum").html(($('#sell_num').val() * $('#sell_price').val()).toFixed(8) * 1);
            } else {
                $('#sell_num').val('');
                $('#sell_mum').html('0.00');
            }
        }

        if(type == 'buy'){
            /*		if ($("#sell_usable").html() > 0 && nums > 0) {
                        if (bs_num >= $("#sell_usable").html()) {
                            $("#sell_num").val($("#sell_usable").html());
                        } else {
                            $('#sell_num').val(bs_num);
                        }
                    }*/
            var obj = $(_this).parents('#buylist').children();

            var this_id = $(_this).children(".num").data("id");
            var this_val= parseFloat($(_this).children(".num").data("val"));

            for(var j = 0;j<this_id;j++){
                this_val +=parseFloat($(obj[j]).children(".num").data("val"));
            }
            $('#buy_num').val(this_val)
            $('#sell_num').val(this_val)
            if ($('#buy_num').val()) {
                $('#buy_num').val();
                $("#buy_mum").html(($('#buy_num').val() * $('#buy_price').val()).toFixed(8) * 1);
            } else {
                $('#buy_num').val('');
                $('#buy_mum').html('0.00');
            }

            if ($('#sell_num').val()) {
                $('#sell_num').val()
                $("#sell_mum").html(($('#sell_num').val() * $('#sell_price').val()).toFixed(8) * 1);
            } else {
                $('#sell_num').val('');
                $('#sell_mum').html('0.00');
            }
        }
    }
    /**
     * 币种
     * */
    function currency(data) {

        if(data){
            var list='';
            for(var i in data['list']){
                ifcolor = (data['list'][i]['change'] >= 0 ? 'red' : 'green');

                list+='<li><dl><a href="/Trade/index/market/'+data['list'][i]['name']+'"><dt class="fll market" style="width: 33%"><i></i><img src="__UPLOAD__/coin/'+data['list'][i]['img']+'?v=1237777" width="20" height="20" alt="" /><span class="coin_name">'+data['list'][i]['coin_name']+'</span></dt><dd class="fl ' + ifcolor + '" style="width: 42%"><i></i>'+data['list'][i]['new_price']+'</dd><dd class="fl tl ' + ifcolor + '" style="width: 25%">' + (parseFloat(data['list'][i]['change']) < 0 ? '' : '+') + ((parseFloat(data['list'][i]['change']) < 0.01 && parseFloat(data['list'][i]['change']) > -0.01) ? "0.00" : (parseFloat(data['list'][i]['change'])).toFixed(2)) + '%<i></i></dd></a></dl></li>';
            }
            $("#all_coin").html(list);
        }
    }
    /**
     * 最新交易信息
     * */
    function newestOrder(data) {
        if(data){
            if(data['tradelog']){

                var list='';
                var type='';
                var typename='';

                for( var i in data['tradelog']){
                    if(data['tradelog'][i]['type']==1){
                        list+='<li class="red"><dl onclick="autotrust(this,\'buy\',1)"><dd class="fl" style="width:35%">'+data['tradelog'][i]['addtime']+'</dd><dd class="fl" style="width:35%">'+(data['tradelog'][i]['price']).toFixed(market_round_num)+'</dd><dd class="fl tr"  style="width:30%" >'+(data['tradelog'][i]['num']).toFixed(4)+'</dd></dl></li>';
                    }else{
                        list+='<li class="green"><dl onclick="autotrust(this,\'sell\',1)"><dd class="fl" style="width:35%">'+data['tradelog'][i]['addtime']+'</dd><dd class="fl" style="width:35%">'+(data['tradelog'][i]['price']).toFixed(market_round_num)+'</dd><dd class="fl tr" style="width:30%">'+(data['tradelog'][i]['num']).toFixed(4)+'</dd></dl></li>';
                    }
                }
                $("#orderlist").html(list);
            }
        }
    }
    /**
     * 暂时未知
     * 可能是涨跌幅信息
     * */
    function getJsonTops(data){
        if(data){
            if(data['info']['new_price']){
                $('#market_new_price').removeClass('buy');
                $('#market_new_price').removeClass('sell');

                if(data['info']['change'] == 0 || data['info']['change'] > 0){
                    $('#market_new_price').addClass('buy');
                }else{
                    $('#market_new_price').addClass('sell');
                }
                var num = (data['info']['new_price'] * "{$config['usdt']}")*1
                console.log('x'+data['info']['new_price']);
                console.log('y'+"{$config['usdt']}");
                $("#market_new_price").html(data['info']['new_price']);
                $("#cny_prices").html('≈' + num + "CNY");
                $("title").html(data['info']['new_price'] + " | {$coin_name}-{$coin_type} | {:C('web_title')}");
            }
            if(data['info']['buy_price']){
                $('#market_buy_price').removeClass('buy');
                $('#market_buy_price').removeClass('sell');

                if($("#market_buy_price").html()>data['info']['buy_price']){
                    $('#market_buy_price').addClass('sell');
                }
                if($("#market_buy_price").html()<data['info']['buy_price']){
                    $('#market_buy_price').addClass('buy');
                }

                $("#market_buy_price").html(data['info']['buy_price']);
                $("#sell_best_price").html('￥'+data['info']['buy_price']);
            }
            if(data['info']['sell_price']){
                $('#market_sell_price').removeClass('buy');
                $('#market_sell_price').removeClass('sell');

                if($("#market_sell_price").html()>data['info']['sell_price']){
                    $('#market_sell_price').addClass('sell');
                }
                if($("#market_sell_price").html()<data['info']['sell_price']){
                    $('#market_sell_price').addClass('buy');
                }

                $("#market_sell_price").html(data['info']['sell_price']);
                $("#buy_best_price").html('￥'+data['info']['sell_price']);
            }
            if(data['info']['max_price']){
                $("#market_max_price").html(data['info']['max_price']);
            }
            if(data['info']['min_price']){
                $("#market_min_price").html(data['info']['min_price']);
            }
            if(data['info']['volume']){
                if(data['info']['volume']>10000){
                    data['info']['volume']=(data['info']['volume']/10000).toFixed(2)+"万"
                }
                if(data['info']['volume']>100000000){
                    data['info']['volume']=(data['info']['volume']/100000000).toFixed(2)+"亿"
                }
                $("#market_volume").html(data['info']['volume']);
            }
            if(data['info']['change'] || data['info']['change'] == 0){
                $('#market_change').removeClass('buy');
                $('#market_change').removeClass('sell');
                //涨跌幅价格
                if(data['info']['change'] == 0){
                    console.log(data['info']['change']);
                    $('#market_change').addClass('buy');
                    $("#market_change").html("+0.00%");
                }else if(data['info']['change'] > 0){
                    $('#market_change').addClass('buy');

                    $("#market_change").html('+' +parseFloat(data['info']['change']).toFixed(2)+"%");
                }else{
                    $('#market_change').addClass('sell');
                    $("#market_change").html(parseFloat(data['info']['change']).toFixed(2)+"%");
                }
            }
        }
    }
    /**
     * 我的财产 我的委托
     * @param data
     */
    function myGetzican(data) {
        if(data){
            if(data['entrust']){
                $('#entrust_over').show();
                var list='';
                var cont=data['entrust'].length;
                var status_name = '--';
                //console.log(cont);
                // 委托信息
                for(i=0; i<=data['entrust'].length-1; i++){
                    if(data['entrust'][i]['type']==1){
                        if(data['entrust'][i]['status'] == 0){status_name = "{:L('交易中')}";}
                        else if(data['entrust'][i]['status'] == 1){status_name = "{:L('已完成')}";}
                        else if(data['entrust'][i]['status'] == 2){status_name = "{:L('已撤销')}";}

                        list+='<li><dl><dd class="fl" style="width: 20%"><i></i>'+data['entrust'][i]['addtime']+'</dd><dd class="fl red" style="width: 25%"><i></i>{:L('买')} '+(data['entrust'][i]['price']).toFixed(market_round)+'</dd><dd class="fl red" style="width: 35%"><i></i>'+(data['entrust'][i]['num']).toFixed(market_round_num)+' / '+(data['entrust'][i]['deal']).toFixed(market_round_num)+'</dd><dd class="fl tc"  style="width: 10%">'+status_name+'</dd><dd class="fl tc" style="width: 10%"><a class="green" id="'+data['entrust'][i]['id']+'" onclick="cancelaa(\''+data['entrust'][i]['id']+'\')" href="javascript:void(0);">{:L('取消')}</a></dd></dl></li>';
                    }else{
                        if(data['entrust'][i]['status'] == 0){status_name = "{:L('交易中')}";}
                        else if(data['entrust'][i]['status'] == 1){status_name = "{:L('已完成')}";}
                        else if(data['entrust'][i]['status'] == 2){status_name = "{:L('已撤销')}";}

                        list+='<li><dl><dd class="fl" style="width: 20%"><i></i>'+data['entrust'][i]['addtime']+'</dd><dd class="fl green" style="width: 25%"><i></i>{:L('卖')} '+(data['entrust'][i]['price']).toFixed(market_round)+'</dd><dd class="fl green" style="width: 35%"><i></i>'+(data['entrust'][i]['num']).toFixed(market_round_num)+' / '+(data['entrust'][i]['deal']).toFixed(market_round_num)+'</dd><dd class="fl tc"  style="width: 10%">'+status_name+'</dd><dd class="fl tc" style="width: 10%"><a class="green" id="'+data['entrust'][i]['id']+'" onclick="cancelaa(\''+data['entrust'][i]['id']+'\')" href="javascript:void(0);">{:L('取消')}</a></dd></dl></li>';
                    }
                }
                $('#entrustlist').html(list);
            }else{
                $('#entrust_over').hide();
                $("#entrustlist li").remove();
            }

            // 我的财产信息
            if(data['usercoin']){
                if(data['usercoin']['rmb']){
                    $("#buy_usable").html(data['usercoin']['rmb'].toFixed(5) * 1);
                    if($('#buy_price').val()>0){
                        $("#buy_max").html(((data['usercoin']['rmb']/$('#buy_price').val()).toFixed(market_round_num) * 1));
                    }else{
                        $("#buy_max").html(0);
                    }
                }else{
                    $("#buy_usable").html('0.00');
                }

                if(data['usercoin']['rmbd']){
                    $("#buy_usabled").html(data['usercoin']['rmbd'].toFixed(market_round_num) * 1);
                }else{
                    $("#buy_usabled").html('0.00');
                }

                if(data['usercoin']['xnb']){
                    console.log(market_round_num);
                    $("#sell_usable").html(data['usercoin']['xnb'].toFixed(market_round_num) * 1);
                    $("#sell_max").html(data['usercoin']['xnb'].toFixed(market_round_num) * 1);
                }else{
                    $("#sell_usable").html('0.00');
                }

                if(data['usercoin']['xnbd']){
                    $("#sell_usabled").html(data['usercoin']['xnbd'].toFixed(market_round_num) * 1);
                }else{
                    $("#sell_usabled").html('0.00');
                }

                if(data['time_state']==0){
                    $("#buybutton").show();
                    $("#buybutton").attr("onclick","ajaxDeal('buybutton')");
                    $("#sellerbutton").show();
                    $("#sellerbutton").attr("onclick","ajaxDeal('sellerbutton');");
                }else{
                    $("#buybutton").show();
                    $("#buybutton").val("{:L('闭盘期间')}");
                    $("#buybutton").css("background","#ccc");
                    $("#buybutton").attr("onclick","ajaxDeal('buybutton')");
                    $("#sellerbutton").show();
                    $("#sellerbutton").val("{:L('闭盘期间')}");
                    $("#sellerbutton").css("background","#ccc");
                    $("#sellerbutton").attr("onclick","ajaxDeal('sellerbutton');");
                }
            }
        }
    }
    /**
     * 交易买卖委托信息
     * */
    function information(data) {
        if(data){
            if(data['depth']){
                var list='';
                var sellk=data['depth']['sell'].length;
                if(data['depth']['sell']){
                    for(i=0; i<data['depth']['sell'].length; i++){
                        list += '<dd onclick="autotrust(this,\'sell\',1,2)"><span class="fl num" data-id="'+i+'" data-val="'+(data['depth']['sell'][i][1]).toFixed(4)+'">'+(data['depth']['sell'][i][1]).toFixed(4)+'</span><span  class="fr sell ">'+(data['depth']['sell'][i][0]).toFixed(market_round_num)+'</span><i class="turntable_bg_green" style="width: '+(data['depth']['sellpbar'][i])+'%"></i></dd>';
                    }
                }
                $("#selllist").html(list);
                list='';
                if(data['depth']['buy']){
                    for(i=0; i<data['depth']['buy'].length; i++){
                        list += '<dd onclick="autotrust(this,\'buy\',0)"><span class="fl buy">'+(data['depth']['buy'][i][0]).toFixed(market_round_num)+'</span><span class="fr num" data-id="'+i+'" data-val="'+(data['depth']['buy'][i][1]).toFixed(4)+'" >'+(data['depth']['buy'][i][1]).toFixed(4)+'</span><i class="turntable_bg_red" style="width: '+(data['depth']['buypbar'][i])+'%"></i></dd>';
                    }
                }
                $("#buylist").html(list);
            }
        }
    }
</script>